---
import client from '@/lib/client'
import { formatDateByTimeZone } from '@/lib/utils'

interface Props {
  class?: string
}

const response = await client.api.github['repo-info'][':owner'][
  ':repository'
].$get({
  param: {
    owner: '0xtaufeeq',
    repository: 'taufeeq.tech'
  }
})
const data = response?.status === 200 ? await response.json() : null

if (!data) {
  console.error('Failed to fetch repository info')
  return
}

// Debug: Log the data structure
console.log('Repository data:', JSON.stringify(data, null, 2))

const commit = data.defaultBranchRef?.target
const username = commit?.author?.user?.login || '0xtaufeeq'
const profileUrl = `https://github.com/${username}`
const commitId = commit?.oid?.slice(0, 7) || ''
const commitUrl = commit?.commitUrl || ''
const date = new Date(commit?.committedDate || data.pushedAt)

// Debug: Log commit data
console.log('Commit data:', { username, commitId, commitUrl, hasDefaultBranch: !!data.defaultBranchRef })

const formattedDate = formatDateByTimeZone(date)

const { class: className } = Astro.props
---

{
  data ? (
    <p class:list={['text-xs min-[961px]:self-end', className]}>
      Last updated by{' '}
      <a
        href={profileUrl}
        target="_blank"
        rel="noopener noreferrer"
        class="font-medium hover:underline transition-colors"
        title={`View ${username}'s GitHub profile`}
      >
        {username}
      </a>
      {' '}on{' '}
      <time datetime={date.toISOString()} class="font-medium">
        {formattedDate} IST
      </time>
      {commitId && commitUrl && (
        <>
          {' '}Â·{' '}
          <a 
            href={commitUrl} 
            target="_blank" 
            rel="noopener noreferrer" 
            class="font-mono hover:underline transition-colors"
            title="View commit on GitHub"
          >
            Commit ID - {commitId}
          </a>
        </>
      )}
    </p>
  ) : (
    // TODO: handle error
    <p>Something went wrong ðŸ˜”</p>
  )
}
